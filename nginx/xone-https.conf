
server {
    listen 80;
    server_name ${DOMAIN_NAME};
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl;
    http2 on;
    server_name ${DOMAIN_NAME};

    # SSL Configuration
    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # Security headers
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # Main App
    location / {
        proxy_pass http://xone-frontend-container:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # Node.js API
    location /napi/ {
        proxy_pass http://node_app:4050/napi/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        
        # Allow large file uploads (streaming uploads)
        client_max_body_size 500m;
        client_body_buffer_size 16m;
        proxy_request_buffering off;
        proxy_buffering off;
        
        # Increase timeouts for large file uploads
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }

    # MinIO Storage
    location /minio/ {
        proxy_pass http://minio:9000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # AI Docs Service - Optimized single location
    location /ai-docs {
        resolver 127.0.0.11 valid=10s;
        set $ai_docs_upstream ai-doc-editor-container:3002;
        
        # Handle static assets and main app in one location
        proxy_pass http://$ai_docs_upstream$request_uri;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Handle upstream errors gracefully
        proxy_intercept_errors on;
        error_page 502 503 504 = @service_fallback;
    }

    # AI Recruiter Service
    location /ai-recruiter {
        resolver 127.0.0.11 valid=10s;
        set $recruiter_upstream ai-recruiter-foloup-1:3000;

        # Remove rewrite ‚Äî keep prefix
        rewrite ^/ai-recruiter/(.*)$ /$1 break;
        proxy_pass http://$recruiter_upstream;

        # --- Uploads: allow larger files and reduce buffering issues ---
        client_max_body_size 50m;
        client_body_buffer_size 16m;
        proxy_request_buffering off;
        proxy_buffering off;

        # --- Comprehensive URL rewriting ---
        proxy_redirect http://ai-recruiter-foloup-1:3000 https://${DOMAIN_NAME};
        proxy_redirect https://ai-recruiter-foloup-1:3000 https://${DOMAIN_NAME};
        sub_filter_once off;
        sub_filter_types text/html application/json application/javascript text/plain application/xml text/xml text/css application/x-javascript text/javascript;
        
        # Multiple URL pattern replacements
        sub_filter 'https://ai-recruiter-foloup-1:3000' 'https://${DOMAIN_NAME}';
        sub_filter 'http://ai-recruiter-foloup-1:3000' 'https://${DOMAIN_NAME}';
        sub_filter 'ai-recruiter-foloup-1:3000' '${DOMAIN_NAME}';
        sub_filter 'http://ai-recruiter-foloup-1:3000/' 'https://${DOMAIN_NAME}/ai-recruiter/';
        sub_filter 'https://ai-recruiter-foloup-1:3000/' 'https://${DOMAIN_NAME}/ai-recruiter/';
        sub_filter 'ai-recruiter-foloup-1:3000/' '${DOMAIN_NAME}/ai-recruiter/';

        # Make upstream handling resilient to transient issues
        proxy_connect_timeout 2s;
        proxy_read_timeout 15s;
        proxy_send_timeout 15s;
        proxy_next_upstream error timeout http_500 http_502 http_503 http_504;
        proxy_next_upstream_tries 3;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        proxy_set_header X-Original-URI $request_uri;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # ‚úÖ Fix for client-side routing (React/Next)
        try_files $uri /ai-recruiter/index.html @pass_ai_recruiter;

        proxy_intercept_errors on;
        error_page 500 502 503 504 = @service_fallback;
    }

    # Static assets for AI Recruiter when page is under /ai-recruiter
    # This avoids white page by ensuring absolute /_next/* assets load from the recruiter app
    location ^~ /_next/ {
        resolver 127.0.0.11 valid=10s;

        # Default to main frontend assets
        set $asset_upstream xone-frontend-container:3000;

        # If the referrer is from /ai-recruiter, serve assets from recruiter upstream
        if ($http_referer ~ "/ai-recruiter/") {
            set $asset_upstream ai-recruiter-foloup-1:3000;
        }

        proxy_pass http://$asset_upstream$request_uri;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Keep buffering conservative for faster failure on wrong upstream
        proxy_connect_timeout 2s;
        proxy_read_timeout 15s;
        proxy_send_timeout 15s;
    }

    # üîÅ Fallback pass for SPA
    location @pass_ai_recruiter {
        resolver 127.0.0.11 valid=10s;
        set $recruiter_upstream ai-recruiter-foloup-1:3000;
        proxy_pass http://$recruiter_upstream;

        # Keep same behavior for deep-links and redirects in fallback
        proxy_redirect http://ai-recruiter-foloup-1:3000 https://${DOMAIN_NAME};
        proxy_redirect https://ai-recruiter-foloup-1:3000 https://${DOMAIN_NAME};
        sub_filter_once off;
        sub_filter_types text/html application/json application/javascript text/plain application/xml text/xml text/css application/x-javascript text/javascript;
        sub_filter 'https://ai-recruiter-foloup-1:3000' 'https://${DOMAIN_NAME}';
        sub_filter 'http://ai-recruiter-foloup-1:3000' 'https://${DOMAIN_NAME}';
        sub_filter 'ai-recruiter-foloup-1:3000' '${DOMAIN_NAME}';
        sub_filter 'http://ai-recruiter-foloup-1:3000/' 'https://${DOMAIN_NAME}/ai-recruiter/';
        sub_filter 'https://ai-recruiter-foloup-1:3000/' 'https://${DOMAIN_NAME}/ai-recruiter/';
        sub_filter 'ai-recruiter-foloup-1:3000/' '${DOMAIN_NAME}/ai-recruiter/';

        # Upload safety in fallback path as well
        client_max_body_size 50m;
        client_body_buffer_size 16m;
        proxy_request_buffering off;
        proxy_buffering off;

        # Same resilient settings for the fallback pass
        proxy_connect_timeout 2s;
        proxy_read_timeout 15s;
        proxy_send_timeout 15s;
        proxy_next_upstream error timeout http_500 http_502 http_503 http_504;
        proxy_next_upstream_tries 3;
    }

    # AI Landing Page Generator Backend API - Optimized
    location /page-revamp-api/ {
        resolver 127.0.0.11 valid=10s;
        set $landing_backend_upstream landing-page-backend:5000;
        
        # Pass the full path to backend (keep /page-revamp-api/ prefix)
        proxy_pass http://$landing_backend_upstream;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        
        # Handle upstream errors gracefully
        proxy_intercept_errors on;
        error_page 502 503 504 = @landing_page_fallback;
    }

     # AI Landing Page Generator Backend API - Optimized
    location /page-revamp-api {
        resolver 127.0.0.11 valid=10s;
        set $landing_backend_upstream landing-page-backend:5000;
        
        # Strip /ai-landing-page-generator prefix when proxying
        rewrite ^/page-revamp-api/(.*)$ /$1 break;
        proxy_pass http://$landing_backend_upstream;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        
        # Handle upstream errors gracefully
        proxy_intercept_errors on;
        error_page 502 503 504 = @landing_page_fallback;
    }

    # AI Landing Page Generator Frontend - Optimized
    location /page-revamp {
        resolver 127.0.0.11 valid=10s;
        set $landing_frontend_upstream landing-page-frontend:3000;
        
        # Pass the full path including /ai-landing-page-generator prefix
        proxy_pass http://$landing_frontend_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Handle upstream errors gracefully
        proxy_intercept_errors on;
        error_page 502 503 504 = @landing_page_fallback;
    }

    # SEO Content Generator - Optimized
    location /blog-engine {
        resolver 127.0.0.11 valid=10s;
        set $seo_frontend_upstream seo-frontend:80;
        
        # Pass the full path including /seo-content-gen prefix
        proxy_pass http://$seo_frontend_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Handle upstream errors gracefully
        proxy_intercept_errors on;
        error_page 502 503 504 = @service_fallback;
    }

    # Call Analyzer Backend API - Optimized
    location /call-analyzer/api/ {
        resolver 127.0.0.11 valid=10s;
        set $call_analyzer_backend_upstream call-analyzer-backend-container:5000;
        
        # Strip /call-analyzer/api prefix when proxying
        rewrite ^/call-analyzer/api/(.*)$ /api/$1 break;
        proxy_pass http://$call_analyzer_backend_upstream;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        
        # Handle upstream errors gracefully
        proxy_intercept_errors on;
        error_page 502 503 504 = @service_fallback;
    }

    # Call Analyzer Frontend - Optimized
    location /call-analyzer {
        resolver 127.0.0.11 valid=10s;
        set $call_analyzer_frontend_upstream call-analyzer-frontend-container:3000;
        
        # Pass the full path including /call-analyzer prefix
        proxy_pass http://$call_analyzer_frontend_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Handle upstream errors gracefully
        proxy_intercept_errors on;
        error_page 502 503 504 = @service_fallback;
    }

    # Reusable fallback for all services
    location @service_fallback {
        return 503 "Service is temporarily unavailable. Please try again later.";
        add_header Content-Type text/plain;
    }

}